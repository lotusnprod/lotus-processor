stages:
  - build-docker
  - test-docker
  - pull-data
  - build-tests
  - test-tests
  - build-databases
  - build-translation
  - build-curating
  - build-analysing
  - build-visualizing

build-docker:
  stage: build-docker
  script:
    - make docker-build
  rules:
    - changes:
        - data/*.dvc
        - src/**/*
        - Dockerfile
        - Makefile
        - .gitlab-ci.yml

test-docker:
  stage: test-docker
  script:
    - docker run --rm -v $PWD:/srv/onpdb onpdb-environment true
  rules:
    - changes:
        - data/*.dvc
        - src/**/*
        - Dockerfile
        - Makefile
        - .gitlab-ci.yml

pull-data:
  stage: pull-data
  script:
    - docker run --rm -v /home/gitlab-runner/.aws:/home/user/.aws -v $PWD:/srv/onpdb -v /srv/onpdb-data/dvc_tmp:/srv/onpdb/.dvc/tmp -v /srv/onpdb-data/dvc:/srv/dvc -v /srv/onpdb-data/external:/srv/onpdb/data/external -v /srv/onpdb-data/interim:/srv/onpdb/data/interim -v /srv/onpdb-data/processed:/srv/onpdb/data/processed -v /srv/onpdb-data/validation:/srv/onpdb/data/validation onpdb-environment bash -c "cd /srv/onpdb && dvc cache dir /srv/dvc && dvc pull -f"
  rules:
    - changes:
        - data/*.dvc
        - .gitlab-ci.yml

build-tests:
  stage: build-tests
  script:
    - docker run --rm -e DATA_PATH=/srv/onpdb/data -e SRC_PATH=/srv/onpdb/src -v /srv/onpdb-data/dvc:/srv/dvc -v /srv/onpdb-data/external:/srv/onpdb/data/external -v /srv/onpdb-data/interim:/srv/onpdb/data/interim -v /srv/onpdb-data/processed:/srv/onpdb/data/processed -v /srv/onpdb-data/validation:/srv/onpdb/data/validation -v $PWD:/srv/onpdb onpdb-environment bash -c "cd /srv/onpdb && make MODE=test curating"
  rules:
    - changes:
        - data/*.dvc
        - src/**/*
        - Makefile
        - .gitlab-ci.yml


test-tests:
  stage: test-tests
  script:
    - docker run --rm -e DATA_PATH=/srv/onpdb/data -e SRC_PATH=/srv/onpdb/src -v /srv/onpdb-data/dvc:/srv/dvc -v /srv/onpdb-data/external:/srv/onpdb/data/external -v /srv/onpdb-data/interim:/srv/onpdb/data/interim -v /srv/onpdb-data/processed:/srv/onpdb/data/processed -v /srv/onpdb-data/validation:/srv/onpdb/data/validation -v $PWD:/srv/onpdb onpdb-environment bash -c "cd /srv/onpdb && make MODE=test tests"
  rules:
    - changes:
        - data/*.dvc
        - src/**/*
        - Makefile
        - .gitlab-ci.yml


build-databases:
  stage: build-databases
  script:
    - docker run --rm -e DATA_PATH=/srv/onpdb/data -e SRC_PATH=/srv/onpdb/src -v /srv/onpdb-data/dvc:/srv/dvc -v /srv/onpdb-data/external:/srv/onpdb/data/external -v /srv/onpdb-data/interim:/srv/onpdb/data/interim -v /srv/onpdb-data/processed:/srv/onpdb/data/processed -v /srv/onpdb-data/validation:/srv/onpdb/data/validation -v $PWD:/srv/onpdb onpdb-environment bash -c "cd /srv/onpdb && make gathering-databases"
  rules:
    - changes:
        - data/*.dvc
        - src/1_gathering/db/**/*
        - Makefile
        - .gitlab-ci.yml


build-translation:
  stage: build-translation
  script:
    - docker run --rm -e DATA_PATH=/srv/onpdb/data -e SRC_PATH=/srv/onpdb/src -v /srv/onpdb-data/dvc:/srv/dvc -v /srv/onpdb-data/external:/srv/onpdb/data/external -v /srv/onpdb-data/interim:/srv/onpdb/data/interim -v /srv/onpdb-data/processed:/srv/onpdb/data/processed -v /srv/onpdb-data/validation:/srv/onpdb/data/validation -v $PWD:/srv/onpdb onpdb-environment bash -c "cd /srv/onpdb && make gathering-translation-full"
  rules:
    - changes:
        - data/*.dvc
        - src/1_gathering/translation/**/*
        - Makefile
        - .gitlab-ci.yml

build-curating:
  stage: build-curating
  script:
    - docker run --rm -e DATA_PATH=/srv/onpdb/data -e SRC_PATH=/srv/onpdb/src -v /srv/onpdb-data/dvc:/srv/dvc -v /srv/onpdb-data/external:/srv/onpdb/data/external -v /srv/onpdb-data/interim:/srv/onpdb/data/interim -v /srv/onpdb-data/processed:/srv/onpdb/data/processed -v /srv/onpdb-data/validation:/srv/onpdb/data/validation -v $PWD:/srv/onpdb onpdb-environment bash -c "cd /srv/onpdb && make MODE=min curating"
  rules:
    - changes:
        - data/*.dvc
        - src/2_curating/*
        - Makefile
        - .gitlab-ci.yml

build-analysing:
  stage: build-analysing
  script:
    - docker run --rm -e DATA_PATH=/srv/onpdb/data -e SRC_PATH=/srv/onpdb/src -v /srv/onpdb-data/dvc:/srv/dvc -v /srv/onpdb-data/external:/srv/onpdb/data/external -v /srv/onpdb-data/interim:/srv/onpdb/data/interim -v /srv/onpdb-data/processed:/srv/onpdb/data/processed -v /srv/onpdb-data/validation:/srv/onpdb/data/validation -v $PWD:/srv/onpdb onpdb-environment bash -c "cd /srv/onpdb && make MODE=min analysing"
  rules:
    - changes:
        - data/*.dvc
        - src/3_analysing/*
        - Makefile
        - .gitlab-ci.yml

build-visualizing:
  stage: build-visualizing
  script:
    - docker run --rm -e DATA_PATH=/srv/onpdb/data -e SRC_PATH=/srv/onpdb/src -v /srv/onpdb-data/dvc:/srv/dvc -v /srv/onpdb-data/external:/srv/onpdb/data/external -v /srv/onpdb-data/interim:/srv/onpdb/data/interim -v /srv/onpdb-data/processed:/srv/onpdb/data/processed -v /srv/onpdb-data/validation:/srv/onpdb/data/validation -v $PWD:/srv/onpdb onpdb-environment bash -c "cd /srv/onpdb && make MODE=min visualizing"
  rules:
    - changes:
        - data/*.dvc
        - src/4_visualizing/*
        - Makefile
        - .gitlab-ci.yml
