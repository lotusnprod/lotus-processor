stages:
  - docker
  - test-docker
  - pull-data
  - build-databases

build_docker_image:
  stage: docker
  script:
    - make docker-build

validate_docker_image:
  stage: test-docker
  script:
    - docker run --rm -v $PWD:/srv/onpdb onpdb-environment true

dvc-pull:
  stage: pull-data
  script:
    - docker run --rm -v /home/gitlab-runner/.aws:/home/user/.aws -v $PWD:/srv/onpdb  -v /srv/onpdb-data/dvc:/srv/dvc onpdb-environment bash -c "cd /srv/onpdb && dvc cache dir /srv/dvc && dvc pull -f"

build-databases:
  stage: build-databases
  script:
    - docker run --rm -e DATA_PATH=/srv/onpdb/data -e SRC_PATH=/srv/onpdb/src -v /srv/onpdb-data/dvc:/srv/dvc -v $PWD:/srv/onpdb onpdb-environment make databases
